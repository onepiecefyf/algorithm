package cn.org.bjca.anysign.seal.server.common.wrapper;

import cn.org.bjca.anysign.seal.server.common.utils.JsoupUtil;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletRequestWrapper;
import org.apache.commons.lang3.StringUtils;

/***************************************************************************
 * <pre>XSS 过滤</pre>
 *
 * @author july_whj
 * @文件名称: XssHttpServletRequestWrapper.class
 * @包 路   径：  cn.org.bjca.anysign.seal.global.tools.wrapper
 * @版权所有：北京数字认证股份有限公司 (C) 2018
 * @类描述:
 * @版本: V1.0
 * @创建人： july_whj
 * @创建时间：2018/9/6 17:45
 ***************************************************************************/
public class XssHttpServletRequestWrapper extends HttpServletRequestWrapper {

  HttpServletRequest orgRequest = null;
  private boolean isIncludeRichText = false;
  private static final String CONTENT = "content";
  private static final String WITHHTML = "WithHtml";

  public XssHttpServletRequestWrapper(HttpServletRequest request, boolean isIncludeRichText) {
    super(request);
    orgRequest = request;
    this.isIncludeRichText = isIncludeRichText;
  }

  /**
   * 覆盖getParameter方法，将参数名和参数值都做xss过滤。<br/> 如果需要获得原始的值，则通过super.getParameterValues(name)来获取<br/>
   * getParameterNames,getParameterValues和getParameterMap也可能需要覆盖
   */
  @Override
  public String getParameter(String name) {
    if ((CONTENT.equals(name) || name.endsWith(WITHHTML))) {
      if (!isIncludeRichText) {
        return super.getParameter(name);
      }
    }
    name = JsoupUtil.clean(name);
    String value = super.getParameter(name);
    if (StringUtils.isNotBlank(value)) {
      value = JsoupUtil.clean(value);
    }
    return value;
  }

  @Override
  public String[] getParameterValues(String name) {
    String[] arr = super.getParameterValues(name);
    if (arr != null) {
      for (int i = 0; i < arr.length; i++) {
        arr[i] = JsoupUtil.clean(arr[i]);
      }
    }
    return arr;
  }


  /**
   * 覆盖getHeader方法，将参数名和参数值都做xss过滤。<br/> 如果需要获得原始的值，则通过super.getHeaders(name)来获取<br/> getHeaderNames
   * 也可能需要覆盖
   */
  @Override
  public String getHeader(String name) {
    name = JsoupUtil.clean(name);
    String value = super.getHeader(name);
    if (StringUtils.isNotBlank(value)) {
      value = JsoupUtil.clean(value);
    }
    return value;
  }

  /**
   * 获取最原始的request
   */
  public HttpServletRequest getOrgRequest() {
    return orgRequest;
  }

  /**
   * 获取最原始的request的静态方法
   */
  public static HttpServletRequest getOrgRequest(HttpServletRequest req) {
    if (req instanceof XssHttpServletRequestWrapper) {
      return ((XssHttpServletRequestWrapper) req).getOrgRequest();
    }
    return req;
  }

}